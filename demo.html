<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDTL.</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: "Courier New", Courier, monospace;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        h1 {
            font-size: 2rem;
            transition: opacity 0.5s ease-in-out; /* Smooth fade-out effect */
        }
        p {
            font-size: 1.5rem;
            margin-bottom: 20px;
            white-space: pre-line; /* Ensures new lines are displayed */
        }
        input, button {
            font-size: 1rem;
            padding: 10px;
            margin: 5px;
        }
        a {
            color: lightblue; /* Style hyperlinks */
            text-decoration: underline;
        }
        .separator {
            width: 80%;
            height: 2px;
            background-color: white;
            margin: 20px auto;
        }
        .footer {
            margin-top: 30px;
            font-size: 1rem;
            color: gray;
        }
    </style>
</head>
<body>
    <h1 id="location-title">Detecting Your Location...</h1>
    <p id="state-display">Fetching IP info...</p>

    <!-- Separator -->
    <div class="separator"></div>

    <!-- Search Input -->
    <p>Incorrect area? Please enter your area name to search:</p>
    <input type="text" id="manual-input" placeholder="Enter state or country">
    <button onclick="searchLocation()">Search</button>
    <p id="suggestion" style="color: yellow;"></p>

    <!-- Footer -->
    <p class="footer">In memory of Joshua "Jeremiah" Blackledge, created by Elijah Segers and Maddie Andros</p>

    <script>
        let detectedCountry = "";
        let detectedRegion = "";

        async function getLocation() {
            try {
                const response = await fetch('https://ipwhois.app/json/');
                const data = await response.json();
                console.log("Full API Response:", data);

                detectedCountry = data.country;
                detectedRegion = data.region;

                document.getElementById("state-display").textContent = `${capitalizeFirstLetter(detectedRegion)} CONFIRMED`;
                document.getElementById("location-title").style.opacity = "0";
                setTimeout(() => {
                    document.getElementById("location-title").style.display = "none";
                }, 500);

                searchFiles(detectedRegion, detectedCountry);
            } catch (error) {
                console.error("Error fetching location:", error);
                document.getElementById("state-display").textContent = "Error fetching location.";
            }
        }

        function searchLocation() {
            let userInput = document.getElementById("manual-input").value.trim();
            if (!userInput) {
                alert("Please enter a location.");
                return;
            }

            // Capitalize and auto-correct input
            userInput = capitalizeFirstLetter(userInput);
            let correctedName = findClosestMatch(userInput);
            if (correctedName && correctedName.toLowerCase() !== userInput.toLowerCase()) {
                document.getElementById("suggestion").textContent = `Did you mean: ${correctedName}?`;
                userInput = capitalizeFirstLetter(correctedName);
            } else {
                document.getElementById("suggestion").textContent = "";
            }

            searchFiles(userInput, detectedCountry || "Global");
        }

        async function searchFiles(region, country) {
            const folderPath = `${country}/${region}.txt`;

            try {
                const response = await fetch(folderPath);
                if (!response.ok || response.headers.get("Content-Type").includes("text/html")) {
                    throw new Error("File not found");
                }

                const text = await response.text();
                document.getElementById("state-display").innerHTML = formatText(text.trim());
            } catch (error) {
                console.warn(`File not found for ${region}, showing fallback message.`);
                document.getElementById("state-display").textContent = `No data available for ${region}.`;
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function formatText(text) {
            text = text.replace(/(\+?\d{1,3}[-.\s]?)?(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g, '<a href="tel:$&">$&</a>');
            text = text.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, function(url) {
                let formattedUrl = url.startsWith("www.") ? "http://" + url : url;
                return `<a href="${formattedUrl}" target="_blank">${url}</a>`;
            });
            return text;
        }

        function findClosestMatch(input) {
            let closestMatch = "";
            let shortestDistance = Infinity;

            validLocations.forEach(location => {
                let distance = levenshteinDistance(input.toLowerCase(), location.toLowerCase());
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    closestMatch = location;
                }
            });

            return shortestDistance <= 2 ? closestMatch : "";
        }

        function levenshteinDistance(a, b) {
            const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
                Array.from({ length: b.length + 1 }, (_, j) => (i === 0 ? j : j === 0 ? i : 0))
            );

            for (let i = 1; i <= a.length; i++) {
                for (let j = 1; j <= b.length; j++) {
                    matrix[i][j] =
                        a[i - 1] === b[j - 1]
                            ? matrix[i - 1][j - 1]
                            : Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + 1);
                }
            }

            return matrix[a.length][b.length];
        }

        const validLocations = [
            "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware",
            "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky",
            "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi",
            "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico",
            "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania",
            "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont",
            "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming",
            "United States", "Canada", "Mexico", "Brazil", "Argentina", "United Kingdom", "France", "Germany",
            "Italy", "Spain", "China", "Japan", "India", "Russia", "South Africa", "Australia"
        ];

        getLocation();
    </script>
</body>
</html>
