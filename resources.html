<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resources | YDTL</title>
  <style>
    :root {
      --bg-color: black;
      --text-color: white;
      --link-color: lightblue;
      --border-color: gray;
    }

    body.light {
      --bg-color: white;
      --text-color: black;
      --link-color: blue;
      --border-color: lightgray;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: "Courier New", Courier, monospace;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    nav {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-color);
      padding: 10px 0;
      display: flex;
      justify-content: center;
      gap: 40px;
      font-size: 0.95rem;
    }

    nav a {
      color: var(--text-color);
      text-decoration: none;
    }

    nav a:hover {
      text-decoration: underline;
    }

    .mode-toggle {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 0.9rem;
      background: none;
      color: var(--text-color);
      border: 1px solid var(--text-color);
      padding: 5px 10px;
      cursor: pointer;
    }

    #content-box {
      margin-top: 100px;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      width: 100%;
    }

    #state-display {
      font-size: 1.2rem;
      white-space: pre-line;
      padding: 10px;
    }

    .search-container {
      margin-top: 20px;
      text-align: center;
    }

    input, button {
      font-size: 1rem;
      padding: 8px;
      margin: 5px;
      width: 250px;
      max-width: 90vw;
    }

    button {
      cursor: pointer;
    }

    a {
      color: var(--link-color);
      text-decoration: underline;
      word-break: break-word;
    }

    .footer {
      font-size: 0.9rem;
      color: var(--border-color);
      text-align: center;
      margin-top: auto;
      padding-bottom: 20px;
    }

    .footer a {
      color: var(--border-color);
    }

    .footer a:hover {
      color: var(--link-color);
    }

    @media (max-width: 600px) {
      nav {
        gap: 20px;
        font-size: 0.85rem;
        flex-wrap: wrap;
      }

      #state-display {
        font-size: 1rem;
      }

      input, button {
        width: 90%;
      }

      .footer {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/resources">Resources</a>
    <a href="/about">About</a>
    <button class="mode-toggle" onclick="toggleMode()">Toggle Mode</button>
  </nav>

  <div class="search-container">
    <p>Incorrect area? Please enter your area name to search:</p>
    <input type="text" id="manual-input" placeholder="Enter state or country" />
    <button onclick="searchLocation()">Search</button>
    <p id="suggestion" style="color: yellow;"></p>
  </div>

  <div id="content-box">
    <p id="state-display">Fetching IP info...</p>
  </div>

  <p class="footer">
    In memory of <a href="https://github.com/youdeservetolive/youdeservetolive.github.io/blob/main/README.md" target="_blank" rel="noopener noreferrer">Joshua Blackledge</a> â€” created by Elijah Segers and Maddie Andros
  </p>

  <script>
    let detectedCountry = "";
    let detectedRegion = "";

    function toggleMode() {
      document.body.classList.toggle("light");
    }

    async function getLocation() {
      try {
        const response = await fetch("https://ipwhois.app/json/");
        const data = await response.json();
        detectedCountry = capitalizeWords(data.country);
        detectedRegion = capitalizeWords(data.region);
        updateDisplay(`${detectedRegion} CONFIRMED`);
        searchFiles(detectedRegion, detectedCountry);
      } catch (error) {
        updateDisplay("Error fetching location.");
      }
    }

    function searchLocation() {
      let userInput = document.getElementById("manual-input").value.trim();
      if (!userInput) return alert("Please enter a location.");

      userInput = capitalizeWords(userInput);
      let corrected = findClosestMatch(userInput);

      document.getElementById("suggestion").textContent =
        corrected && corrected.toLowerCase() !== userInput.toLowerCase()
          ? `Did you mean: ${corrected}?`
          : "";

      const isCountry = validCountries.includes(corrected);
      const isRegion = validStates.includes(corrected);

      if (isCountry) searchFiles(corrected, corrected);
      else if (isRegion) searchFiles(corrected, "United States");
      else updateDisplay(`No data available for "${userInput}".`);
    }

    async function searchFiles(region, country) {
      let path = country === "United States" ? `United States/${region}.txt` : `${country}/${country}.txt`;

      try {
        const res = await fetch(path);
        if (!res.ok || res.headers.get("Content-Type").includes("text/html")) throw new Error();
        const text = await res.text();
        updateDisplay(formatText(text.trim()));
      } catch {
        if (country === "United States") {
          try {
            const fallback = await fetch("United States/USA.txt");
            const text = await fallback.text();
            updateDisplay(`Your state either isn't currently supported, or lacks resources. Listed below are your location's national resources:\n\n${formatText(text.trim())}`);
          } catch {
            updateDisplay("No data available for your U.S. region.");
          }
        } else {
          try {
            const fallback = await fetch("NotSupported.json");
            const data = await fallback.json();
            if (data[country]) {
              let info = `Your country either isn't currently supported, or lacks resources. Listed below are your location's national resources:\n\n`;
              for (let key in data[country]) info += `${key}: ${data[country][key]}\n`;
              updateDisplay(info.trim());
            } else updateDisplay(`No fallback data for ${country}.`);
          } catch {
            updateDisplay("Error loading fallback emergency contacts.");
          }
        }
      }
    }

    function updateDisplay(text) {
      document.getElementById("state-display").innerHTML = text;
    }

    function capitalizeWords(str) {
      return str.toLowerCase().split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
    }

    function formatText(text) {
      text = text.replace(/(\+?\d{1,3}[-.\s]?)?(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g, '<a href="tel:$&">$&</a>');
      text = text.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, url => `<a href="${url.startsWith('www.') ? 'http://' + url : url}" target="_blank">${url}</a>`);
      return text;
    }

    function findClosestMatch(input) {
      let closest = "", dist = Infinity;
      [...validStates, ...validCountries].forEach(loc => {
        let d = levenshteinDistance(input.toLowerCase(), loc.toLowerCase());
        if (d < dist) { dist = d; closest = loc; }
      });
      return dist <= 2 ? closest : input;
    }

    function levenshteinDistance(a, b) {
      const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
        Array.from({ length: b.length + 1 }, (_, j) => (i === 0 ? j : j === 0 ? i : 0)));

      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          matrix[i][j] = a[i - 1] === b[j - 1] ? matrix[i - 1][j - 1] :
            Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + 1);
        }
      }
      return matrix[a.length][b.length];
    }

    const validStates = ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"];

    const validCountries = ["United States", "Canada", "Mexico", "Brazil", "Argentina", "United Kingdom", "France", "Germany", "Italy", "Spain", "China", "Japan", "India", "Russia", "South Africa", "Australia"];

    getLocation();
  </script>
</body>
</html>
