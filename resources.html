<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YDTL.</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: "Courier New", Courier, monospace;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 2rem;
      margin-top: 40px;
    }

    p {
      font-size: 1.3rem;
      margin-bottom: 20px;
      white-space: pre-line;
    }

    input, button {
      font-size: 1rem;
      padding: 10px;
      margin: 5px;
      max-width: 90vw;
    }

    input {
      width: 250px;
    }

    button {
      cursor: pointer;
    }

    a {
      color: lightblue;
      text-decoration: underline;
      word-break: break-word;
    }

    .separator {
      width: 90%;
      height: 2px;
      background-color: white;
      margin: 20px auto;
    }

    .footer {
      margin-top: auto;
      font-size: 1rem;
      color: gray;
      text-align: center;
    }

    #content-box {
      min-height: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
      p, input, button {
        font-size: 1rem;
      }
      input {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="content-box">
    <p id="state-display">Fetching IP info...</p>
    <div class="separator"></div>
  </div>

  <p>Incorrect area? Please enter your area name to search:</p>
  <input type="text" id="manual-input" placeholder="Enter state or country" />
  <button onclick="searchLocation()">Search</button>
  <p id="suggestion" style="color: yellow;"></p>
  
  <p class="footer">
    In memory of
    <a href="https://github.com/youdeservetolive/youdeservetolive.github.io/blob/main/README.md" target="_blank" rel="noopener noreferrer">
      Joshua Blackledge
    </a> â€” created by Elijah Segers and Maddie Andros
  </p>

  <script>
    let detectedCountry = "";
    let detectedRegion = "";

    async function getLocation() {
      try {
        const response = await fetch("https://ipwhois.app/json/");
        const data = await response.json();
        console.log("Full API Response:", data);

        detectedCountry = data.country;
        detectedRegion = data.region;

        updateDisplay(`${capitalizeWords(detectedRegion)} CONFIRMED`);
        searchFiles(detectedRegion, detectedCountry);
      } catch (error) {
        console.error("Error fetching location:", error);
        updateDisplay("Error fetching location.");
      }
    }

    function searchLocation() {
      let userInput = document.getElementById("manual-input").value.trim();
      if (!userInput) {
        alert("Please enter a location.");
        return;
      }

      userInput = capitalizeWords(userInput);

      let correctedName = findClosestMatch(userInput);
      if (correctedName && correctedName.toLowerCase() !== userInput.toLowerCase()) {
        document.getElementById("suggestion").textContent = `Did you mean: ${correctedName}?`;
        userInput = capitalizeWords(correctedName);
      } else {
        document.getElementById("suggestion").textContent = "";
      }

      searchFiles(userInput, detectedCountry || "Global");
    }

    async function searchFiles(region, country) {
      const folderPath = `${country}/${region}.txt`;

      try {
        const response = await fetch(folderPath);
        if (!response.ok || response.headers.get("Content-Type").includes("text/html")) {
          throw new Error("File not found");
        }

        const text = await response.text();
        updateDisplay(formatText(text.trim()));
      } catch (error) {
        console.warn(`File not found for ${region}, showing fallback message.`);
        updateDisplay(`No data available for ${region}.`);
      }
    }

    function updateDisplay(text) {
      document.getElementById("state-display").innerHTML = text;
    }

    function capitalizeWords(str) {
      return str
        .toLowerCase()
        .split(" ")
        .filter(word => word.length > 0)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
    }

    function formatText(text) {
      text = text.replace(/(\+?\d{1,3}[-.\s]?)?(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g, '<a href="tel:$&">$&</a>');
      text = text.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, function (url) {
        let formattedUrl = url.startsWith("www.") ? "http://" + url : url;
        return `<a href="${formattedUrl}" target="_blank">${url}</a>`;
      });
      return text;
    }

    function findClosestMatch(input) {
      let closestMatch = "";
      let shortestDistance = Infinity;

      validLocations.forEach(location => {
        let distance = levenshteinDistance(input.toLowerCase(), location.toLowerCase());
        if (distance < shortestDistance) {
          shortestDistance = distance;
          closestMatch = location;
        }
      });

      return shortestDistance <= 2 ? closestMatch : "";
    }

    function levenshteinDistance(a, b) {
      const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
        Array.from({ length: b.length + 1 }, (_, j) => (i === 0 ? j : j === 0 ? i : 0))
      );

      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          matrix[i][j] =
            a[i - 1] === b[j - 1]
              ? matrix[i - 1][j - 1]
              : Math.min(
                  matrix[i - 1][j] + 1,
                  matrix[i][j - 1] + 1,
                  matrix[i - 1][j - 1] + 1
                );
        }
      }

      return matrix[a.length][b.length];
    }

    const validLocations = [
      "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware",
      "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky",
      "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi",
      "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico",
      "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania",
      "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont",
      "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming",
      "United States", "Canada", "Mexico", "Brazil", "Argentina", "United Kingdom", "France", "Germany",
      "Italy", "Spain", "China", "Japan", "India", "Russia", "South Africa", "Australia"
    ];

    getLocation();
  </script>
</body>
</html>
