<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YDTL.</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: "Courier New", Courier, monospace;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      font-size: 2rem;
      margin-top: 20px;
    }

    #content-box {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      width: 100%;
    }

    #state-display {
      font-size: 1.2rem;
      white-space: pre-line;
      padding: 10px;
    }

    .search-container {
      margin-bottom: 20px;
      text-align: center;
    }

    input, button {
      font-size: 1rem;
      padding: 8px;
      margin: 5px;
      width: 250px;
      max-width: 90vw;
    }

    button {
      cursor: pointer;
    }

    a {
      color: lightblue;
      text-decoration: underline;
      word-break: break-word;
    }

    .footer {
      font-size: 0.9rem;
      color: gray;
      text-align: center;
      margin-top: auto;
    }

    .footer a {
      color: gray;
      text-decoration: underline;
    }

    .footer a:hover {
      color: lightgray;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }

      #state-display {
        font-size: 1rem;
      }

      input, button {
        width: 90%;
      }

      .footer {
        font-size: 0.8rem;
        padding-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <h1>You matter.</h1>

  <div class="search-container">
    <p>Incorrect area? Please enter your area name to search:</p>
    <input type="text" id="manual-input" placeholder="Enter state or country" />
    <button onclick="searchLocation()">Search</button>
    <p id="suggestion" style="color: yellow;"></p>
  </div>

  <div id="content-box">
    <p id="state-display">Fetching IP info...</p>
  </div>

  <p class="footer">
    In memory of <a href="https://github.com/youdeservetolive/youdeservetolive.github.io/blob/main/README.md" target="_blank" rel="noopener noreferrer">Joshua Blackledge</a> â€” created by Elijah Segers and Maddie Andros
  </p>

  <script>
    let detectedCountry = "";
    let detectedRegion = "";

    async function getLocation() {
      try {
        const response = await fetch("https://ipwhois.app/json/");
        const data = await response.json();
        detectedCountry = capitalizeWords(data.country);
        detectedRegion = capitalizeWords(data.region);
        updateDisplay(`${detectedRegion} CONFIRMED`);
        searchFiles(detectedRegion, detectedCountry);
      } catch (error) {
        updateDisplay("Error fetching location.");
      }
    }

    function searchLocation() {
      let userInput = document.getElementById("manual-input").value.trim();
      if (!userInput) {
        alert("Please enter a location.");
        return;
      }

      userInput = capitalizeWords(userInput);
      let correctedName = findClosestMatch(userInput);

      if (correctedName && correctedName.toLowerCase() !== userInput.toLowerCase()) {
        document.getElementById("suggestion").textContent = `Did you mean: ${correctedName}?`;
        userInput = capitalizeWords(correctedName);
      } else {
        document.getElementById("suggestion").textContent = "";
      }

      const isCountry = validCountries.includes(userInput);
      const isRegion = validStates.includes(userInput);

      if (isCountry) {
        searchFiles(userInput, userInput);
      } else if (isRegion) {
        searchFiles(userInput, "United States");
      } else {
        updateDisplay(`No data available for "${userInput}".`);
      }
    }

    async function searchFiles(region, country) {
      let filePath = "";

      if (country === "United States") {
        filePath = `United States/${region}.txt`;
      } else {
        filePath = `${country}/${country}.txt`;
      }

      try {
        const response = await fetch(filePath);
        if (!response.ok || response.headers.get("Content-Type").includes("text/html")) {
          throw new Error("File not found");
        }

        const text = await response.text();
        updateDisplay(formatText(text.trim()));
      } catch {
        if (country === "United States") {
          try {
            const fallback = await fetch("United States/USA.txt");
            const fallbackText = await fallback.text();
            updateDisplay(formatText(fallbackText.trim()));
          } catch {
            updateDisplay("No data available for your U.S. region.");
          }
        } else {
          try {
            const jsonFallback = await fetch("NotSupported.json");
            const emergencyData = await jsonFallback.json();

            if (emergencyData[country]) {
              let info = `Emergency contacts for ${country}:\n`;
              for (let key in emergencyData[country]) {
                info += `${key}: ${emergencyData[country][key]}\n`;
              }
              updateDisplay(info.trim());
            } else {
              updateDisplay(`No data available for ${country}.`);
            }
          } catch {
            updateDisplay("Could not load fallback emergency info.");
          }
        }
      }
    }

    function updateDisplay(text) {
      document.getElementById("state-display").innerHTML = text;
    }

    function capitalizeWords(str) {
      return str
        .toLowerCase()
        .split(" ")
        .filter(word => word.length > 0)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
    }

    function formatText(text) {
      text = text.replace(/(\+?\d{1,3}[-.\s]?)?(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g, '<a href="tel:$&">$&</a>');
      text = text.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, function (url) {
        let formattedUrl = url.startsWith("www.") ? "http://" + url : url;
        return `<a href="${formattedUrl}" target="_blank">${url}</a>`;
      });
      return text;
    }

    function findClosestMatch(input) {
      let closestMatch = "";
      let shortestDistance = Infinity;
      const all = [...validStates, ...validCountries];

      all.forEach(location => {
        let distance = levenshteinDistance(input.toLowerCase(), location.toLowerCase());
        if (distance < shortestDistance) {
          shortestDistance = distance;
          closestMatch = location;
        }
      });

      return shortestDistance <= 2 ? closestMatch : "";
    }

    function levenshteinDistance(a, b) {
      const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
        Array.from({ length: b.length + 1 }, (_, j) => (i === 0 ? j : j === 0 ? i : 0))
      );

      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          matrix[i][j] =
            a[i - 1] === b[j - 1]
              ? matrix[i - 1][j - 1]
              : Math.min(
                  matrix[i - 1][j] + 1,
                  matrix[i][j - 1] + 1,
                  matrix[i - 1][j - 1] + 1
                );
        }
      }

      return matrix[a.length][b.length];
    }

    const validStates = [
      "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware",
      "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky",
      "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi",
      "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico",
      "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania",
      "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont",
      "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"
    ];

    const validCountries = [
      "United States", "Canada", "Mexico", "Brazil", "Argentina", "United Kingdom", "France", "Germany",
      "Italy", "Spain", "China", "Japan", "India", "Russia", "South Africa", "Australia"
    ];

    getLocation();
  </script>
</body>
</html>
